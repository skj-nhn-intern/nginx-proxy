name: Build and Test nginx-proxy Instance Image

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      skip_cleanup:
        description: 'Skip resource cleanup (for debugging)'
        required: false
        default: 'false'

env:
  PROMTAIL_VERSION: '3.6.4'
  NODE_EXPORTER_VERSION: '1.10.0'
  NGINX_EXPORTER_VERSION: '0.11.0'

jobs:
  build-and-create-image:
    name: Build and create nginx-proxy image (KR1)
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    steps:
      - name: Set KR1 for build and test
        run: |
          echo "NHN_REGION=KR1" >> $GITHUB_ENV
          if [ -n "${{ secrets.NHN_NETWORK_ID_KR1 }}" ]; then
            echo "NHN_NETWORK_ID=${{ secrets.NHN_NETWORK_ID_KR1 }}" >> $GITHUB_ENV
          else
            echo "NHN_NETWORK_ID=${{ secrets.NHN_NETWORK_ID }}" >> $GITHUB_ENV
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node (frontend build)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # cache ìƒëµ: frontend/package-lock.json ê²½ë¡œê°€ runnerì—ì„œ ì—†ì„ ìˆ˜ ìˆì–´ ìºì‹œ ë‹¨ê³„ ì‹¤íŒ¨ ë°©ì§€

      - name: Build frontend dist
        run: |
          if [ ! -f frontend/package.json ]; then
            echo "âš ï¸ frontend/ ì—†ìŒ â€” staticì€ ë¹ˆ í˜ì´ì§€ë¡œ ë‘ "
            mkdir -p frontend/dist
            echo '<!DOCTYPE html><html><body><p>Frontend not in repo.</p></body></html>' > frontend/dist/index.html
          else
            cd frontend && npm ci && npm run build
            cd ..
            [ -d frontend/dist ] || (mkdir -p frontend/dist && echo '<!DOCTYPE html><html><body><p>Build failed.</p></body></html>' > frontend/dist/index.html)
          fi
        env:
          VITE_API_BASE_URL: '/api'

      - name: Set up Python (for CI scripts)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install NHN Cloud CLI dependencies
        run: pip install --upgrade pip && pip install requests

      - name: Create temporary SSH key
        id: ssh_key
        run: |
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/nhn_temp_key -N "" -C "github-actions-temp"
          echo "private_key_path=$HOME/.ssh/nhn_temp_key" >> $GITHUB_OUTPUT
          echo "public_key_path=$HOME/.ssh/nhn_temp_key.pub" >> $GITHUB_OUTPUT
          chmod 600 ~/.ssh/nhn_temp_key

      - name: Create build instance on NHN Cloud
        id: create_instance
        env:
          NHN_AUTH_URL: ${{ secrets.NHN_AUTH_URL }}
          NHN_TENANT_ID: ${{ secrets.NHN_TENANT_ID }}
          NHN_USERNAME: ${{ secrets.NHN_USERNAME }}
          NHN_PASSWORD: ${{ secrets.NHN_PASSWORD }}
          NHN_FLAVOR_NAME: ${{ secrets.NHN_FLAVOR_NAME }}
          NHN_IMAGE_NAME: ${{ secrets.NHN_IMAGE_NAME }}
          NHN_SECURITY_GROUP_ID: ${{ secrets.NHN_SECURITY_GROUP_ID }}
          NHN_FLOATING_IP_POOL: ${{ secrets.NHN_FLOATING_IP_POOL }}
          NHN_NETWORK_ID: ${{ env.NHN_NETWORK_ID }}
          NHN_REGION: ${{ env.NHN_REGION }}
          SSH_PUBLIC_KEY: ${{ steps.ssh_key.outputs.public_key_path }}
        run: python3 scripts/ci/create_build_instance.py

      - name: Wait for SSH to be ready
        run: |
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
                -i ${{ steps.ssh_key.outputs.private_key_path }} \
                ubuntu@${{ steps.create_instance.outputs.instance_ip }} \
                "echo 'SSH OK'" 2>/dev/null; then
              echo "âœ… SSH ì—°ê²° ê°€ëŠ¥"
              break
            fi
            attempt=$((attempt + 1))
            echo "  ì‹œë„ $attempt/$max_attempts..."
            sleep 10
          done
          if [ $attempt -eq $max_attempts ]; then echo "âŒ SSH ì‹¤íŒ¨"; exit 1; fi

      - name: Upload nginx-proxy source to build instance
        run: |
          rsync -avz --exclude='.git' --exclude='*.md' \
            -e "ssh -o StrictHostKeyChecking=no -i ${{ steps.ssh_key.outputs.private_key_path }}" \
            ./ ubuntu@${{ steps.create_instance.outputs.instance_ip }}:/tmp/nginx-proxy/
          echo "BACKEND_UPSTREAM=\"127.0.0.1:8000\"" | \
            ssh -o StrictHostKeyChecking=no -i ${{ steps.ssh_key.outputs.private_key_path }} \
            ubuntu@${{ steps.create_instance.outputs.instance_ip }} "cat > /tmp/nginx-proxy/.env"
          echo "âœ… ì†ŒìŠ¤ ì—…ë¡œë“œ ì™„ë£Œ"

      - name: Download offline packages (Promtail, node_exporter, nginx-exporter)
        run: |
          mkdir -p offline-packages
          echo "ğŸ“¥ Promtail..."
          curl -sSL -o offline-packages/promtail.zip \
            "https://github.com/grafana/loki/releases/download/v${PROMTAIL_VERSION}/promtail-linux-amd64.zip"
          echo "ğŸ“¥ node_exporter..."
          curl -sSL -o offline-packages/node_exporter.tar.gz \
            "https://github.com/prometheus/node_exporter/releases/download/v${NODE_EXPORTER_VERSION}/node_exporter-${NODE_EXPORTER_VERSION}.linux-amd64.tar.gz"
          echo "ğŸ“¥ nginx-prometheus-exporter..."
          curl -sSL -o offline-packages/nginx-exporter.tar.gz \
            "https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v${NGINX_EXPORTER_VERSION}/nginx-prometheus-exporter_${NGINX_EXPORTER_VERSION}_linux_amd64.tar.gz"
          echo "âœ… ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"

      - name: Upload offline packages to build instance
        run: |
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -i ${{ steps.ssh_key.outputs.private_key_path }}" \
            offline-packages/ ubuntu@${{ steps.create_instance.outputs.instance_ip }}:/tmp/offline-packages/
          echo "âœ… ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ ì™„ë£Œ"

      - name: Build nginx-proxy image on instance
        run: |
          ssh -o StrictHostKeyChecking=no \
            -i ${{ steps.ssh_key.outputs.private_key_path }} \
            ubuntu@${{ steps.create_instance.outputs.instance_ip }} << 'REMOTE_SCRIPT'
          set -euo pipefail

          echo "=== nginx ì„¤ì¹˜ ë° íŠ¸ë˜í”½ íš¨ìœ¨ ì„¤ì • ==="
          sudo DEBIAN_FRONTEND=noninteractive apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq nginx curl unzip
          sudo sed -i 's/worker_connections [0-9]*/worker_connections 65535/' /etc/nginx/nginx.conf 2>/dev/null || true
          grep -q 'worker_processes auto' /etc/nginx/nginx.conf 2>/dev/null || sudo sed -i 's/worker_processes [^;]*/worker_processes auto/' /etc/nginx/nginx.conf 2>/dev/null || true

          echo "=== /opt/nginx-proxy ë°°ì¹˜ ==="
          sudo mkdir -p /opt/nginx-proxy/conf /opt/nginx-proxy/conf.d /opt/nginx-proxy/deploy /opt/nginx-proxy/scripts /opt/nginx-proxy/static
          sudo rsync -a /tmp/nginx-proxy/conf/ /opt/nginx-proxy/conf/
          sudo rsync -a /tmp/nginx-proxy/deploy/ /opt/nginx-proxy/deploy/
          sudo rsync -a /tmp/nginx-proxy/scripts/ /opt/nginx-proxy/scripts/ 2>/dev/null || true
          sudo chmod +x /opt/nginx-proxy/deploy/*.sh /opt/nginx-proxy/scripts/*.sh 2>/dev/null || true
          if [ -d /tmp/nginx-proxy/frontend/dist ] && [ -n "$(ls -A /tmp/nginx-proxy/frontend/dist 2>/dev/null)" ]; then
            sudo cp -r /tmp/nginx-proxy/frontend/dist/* /opt/nginx-proxy/static/
            echo "  Frontend static ë³µì‚¬ ì™„ë£Œ"
          else
            echo '<!DOCTYPE html><html><body><p>Frontend not built.</p></body></html>' | sudo tee /opt/nginx-proxy/static/index.html > /dev/null
            echo "  Frontend ì—†ìŒ â€” placeholder index.html ì‚¬ìš©"
          fi

          echo "=== backend.upstream.conf ìƒì„± ==="
          sed "s|__BACKEND_UPSTREAM__|127.0.0.1:8000|g" \
            /opt/nginx-proxy/conf/backend.upstream.conf.template | \
            sudo tee /opt/nginx-proxy/conf.d/backend.upstream.conf > /dev/null

          echo "=== nginx ì„¤ì • ì ìš© ==="
          sudo cp /opt/nginx-proxy/conf/nginx-proxy.conf /etc/nginx/conf.d/nginx-proxy.conf
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t

          echo "=== Promtail (Loki) ==="
          sudo mkdir -p /opt/promtail /var/lib/promtail
          unzip -q /tmp/offline-packages/promtail.zip -d /tmp/
          sudo mv /tmp/promtail-linux-amd64 /opt/promtail/promtail 2>/dev/null || sudo mv /tmp/promtail /opt/promtail/promtail
          sudo chmod +x /opt/promtail/promtail
          sudo cp /opt/nginx-proxy/conf/promtail-config.yaml /opt/promtail/promtail-config.yaml
          sudo cp /opt/nginx-proxy/conf/promtail.service /etc/systemd/system/promtail.service

          echo "=== node_exporter ==="
          sudo useradd -r -s /usr/sbin/nologin -d /opt/node_exporter node-exporter 2>/dev/null || true
          sudo mkdir -p /opt/node_exporter
          sudo tar -xzf /tmp/offline-packages/node_exporter.tar.gz -C /tmp/
          sudo mv /tmp/node_exporter-*.linux-amd64/node_exporter /opt/node_exporter/
          sudo rm -rf /tmp/node_exporter-*.linux-amd64
          sudo chown -R node-exporter:node-exporter /opt/node_exporter
          sudo cp /opt/nginx-proxy/conf/node_exporter.service /etc/systemd/system/node_exporter.service

          echo "=== nginx-prometheus-exporter ==="
          sudo useradd -r -s /usr/sbin/nologin -d /opt/nginx-exporter nginx-exporter 2>/dev/null || true
          sudo mkdir -p /opt/nginx-exporter
          sudo tar -xzf /tmp/offline-packages/nginx-exporter.tar.gz -C /tmp/
          if [ -f /tmp/nginx-prometheus-exporter ]; then
            sudo mv /tmp/nginx-prometheus-exporter /opt/nginx-exporter/
          else
            sudo mv /tmp/nginx-prometheus-exporter_*_linux_amd64/nginx-prometheus-exporter /opt/nginx-exporter/ 2>/dev/null || true
          fi
          sudo chown -R nginx-exporter:nginx-exporter /opt/nginx-exporter
          sudo chmod +x /opt/nginx-exporter/nginx-prometheus-exporter 2>/dev/null || true
          sudo cp /opt/nginx-proxy/conf/nginx-exporter.service /etc/systemd/system/nginx-exporter.service

          echo "=== Pushgateway í‘¸ì‹œ ==="
          sudo cp /opt/nginx-proxy/conf/pushgateway-push.service /etc/systemd/system/
          sudo cp /opt/nginx-proxy/conf/pushgateway-push.timer /etc/systemd/system/

          sudo cp /tmp/nginx-proxy/.env /opt/nginx-proxy/.env 2>/dev/null || true
          sudo systemctl daemon-reload
          sudo systemctl enable nginx node_exporter nginx-exporter pushgateway-push.timer
          sudo systemctl start nginx node_exporter nginx-exporter
          sudo systemctl start pushgateway-push.timer 2>/dev/null || true
          # Promtailì€ enable ì•ˆ í•¨ â€” LOKI_URL ì„¤ì • í›„ apply-env-and-restart.shì—ì„œ enable+start
          [ -n "$(grep -E '^LOKI_URL=' /opt/nginx-proxy/.env 2>/dev/null | cut -d= -f2)" ] && sudo systemctl enable promtail 2>/dev/null && sudo systemctl start promtail 2>/dev/null || true

          sudo rm -rf /tmp/nginx-proxy /tmp/offline-packages /tmp/promtail-linux-amd64
          echo "âœ… nginx-proxy ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
          REMOTE_SCRIPT
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ë¹Œë“œ ì™„ë£Œ"

      - name: Verify nginx before image creation
        run: |
          INSTANCE_IP="${{ steps.create_instance.outputs.instance_ip }}"
          code=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 "http://${INSTANCE_IP}:80/" || echo "000")
          if [[ "$code" != "000" ]]; then
            echo "âœ… nginx ì‘ë‹µ HTTP $code (ìƒíƒœë§Œ í™•ì¸, ë°±ì—”ë“œ ë¬´ê´€)"
          else
            echo "âŒ nginx ë¯¸ì‘ë‹µ (ì—°ê²° ì‹¤íŒ¨)"; exit 1
          fi

      - name: Prepare image for first-boot SSH (cloud-init clean)
        run: |
          ssh -o StrictHostKeyChecking=no -i ${{ steps.ssh_key.outputs.private_key_path }} \
            ubuntu@${{ steps.create_instance.outputs.instance_ip }} \
            "sudo cloud-init clean && sudo sync"
          echo "âœ… cloud-init ìƒíƒœ ì´ˆê¸°í™” ì™„ë£Œ â†’ ì´ ì´ë¯¸ì§€ë¡œ ë„ìš´ ì¸ìŠ¤í„´ìŠ¤ëŠ” ì²« ë¶€íŒ… ì‹œ cloud-initì´ ì‹¤í–‰ë˜ì–´ SSH í‚¤ê°€ ì£¼ì…ë©ë‹ˆë‹¤."

      - name: Stop instance before creating image
        env:
          TOKEN: ${{ steps.create_instance.outputs.token }}
          COMPUTE_URL: ${{ steps.create_instance.outputs.compute_url }}
          INSTANCE_ID: ${{ steps.create_instance.outputs.instance_id }}
        run: python3 scripts/ci/stop_instance.py

      - name: Create image from instance
        id: create_image
        env:
          TOKEN: ${{ steps.create_instance.outputs.token }}
          COMPUTE_URL: ${{ steps.create_instance.outputs.compute_url }}
          INSTANCE_ID: ${{ steps.create_instance.outputs.instance_id }}
        run: python3 scripts/ci/create_image.py

      - name: Cleanup resources
        if: ${{ always() && github.event.inputs.skip_cleanup != 'true' }}
        env:
          TOKEN: ${{ steps.create_instance.outputs.token }}
          COMPUTE_URL: ${{ steps.create_instance.outputs.compute_url }}
          BUILD_INSTANCE_ID: ${{ steps.create_instance.outputs.instance_id }}
          BUILD_FLOATING_IP_ID: ${{ steps.create_instance.outputs.floating_ip_id }}
          KEYPAIR_NAME: ${{ steps.create_instance.outputs.keypair_name }}
        run: python3 scripts/ci/cleanup.py

      - name: Summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Instance IP: ${{ steps.create_instance.outputs.instance_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "- Image Name: ${{ steps.create_image.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Image ID: ${{ steps.create_image.outputs.image_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Region: ${{ env.NHN_REGION }}" >> $GITHUB_STEP_SUMMARY
