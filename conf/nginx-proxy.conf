# Nginx Proxy — 백엔드 API 로드밸런서 앞단 리버스 프록시
# - 클라이언트 IP 무조건 추적 (X-Forwarded-For, X-Real-IP)
# - /api/* → 백엔드 API, /share/* → 공유 링크(photo-api), /health → 헬스
# - 트래픽 효율: 버퍼·타임아웃·업스트림 keepalive
# - SSL은 추후 추가 예정 (아래 HTTPS 블록 참고)

# 업스트림: conf.d/backend.upstream.conf 에서 정의 (NHN Deploy 시 BACKEND_UPSTREAM으로 생성)
include /opt/nginx-proxy/conf.d/backend.upstream.conf;

# ========== 트래픽 효율 (http 컨텍스트) ==========
proxy_buffer_size 128k;
proxy_buffers 4 256k;
proxy_busy_buffers_size 256k;
proxy_max_temp_file_size 0;
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;

server {
    listen 80;
    server_name _;
    # client_max_body_size: 사진 업로드 등 대용량 요청
    client_max_body_size 100M;

    access_log /var/log/nginx/nginx-proxy-access.log;
    error_log  /var/log/nginx/nginx-proxy-error.log;

    # ========== 클라이언트 IP 추적 (필수) ==========
    # 신뢰할 수 있는 프록시(로드밸런서)가 있다면 set_real_ip_from 추가 후 real_ip_header 사용
    # set_real_ip_from 10.0.0.0/8;
    # set_real_ip_from 172.16.0.0/12;
    # set_real_ip_from 192.168.0.0/16;
    # real_ip_header X-Forwarded-For;
    # real_ip_recursive on;

    # API: /api/* → 백엔드 / (prefix 제거)
    location /api/ {
        rewrite ^/api/(.*) /$1 break;
        proxy_pass http://photo_api_backend;

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Host $host;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # 공유 링크(photo-api): /share/{token} — 인증 없이 앨범 공유
    location /share/ {
        proxy_pass http://photo_api_backend;

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Host $host;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # nginx 자체 검증용 (백엔드 무관, CI/로드밸런서용)
    location /_nginx_health {
        access_log off;
        default_type text/plain;
        return 200 'ok\n';
    }

    # 헬스체크 (백엔드 /health 프록시, 로드밸런서/배포 검증용)
    location /health {
        proxy_pass http://photo_api_backend/health;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        access_log off;
    }

    # nginx 메트릭 (Prometheus nginx-exporter용, localhost만 허용)
    location /stub_status {
        stub_status on;
        allow 127.0.0.1;
        deny all;
        access_log off;
    }

    # 루트/기타: 백엔드로 전달 (선택 — 프론트 정적은 별도 서버에서 제공 시 여기서 404 처리 가능)
    location / {
        proxy_pass http://photo_api_backend/;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Host $host;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}

# ========== SSL (추후 적용 시 주석 해제 및 인증서 경로 설정) ==========
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
#
#     ssl_certificate     /etc/nginx/ssl/certificate.crt;
#     ssl_certificate_key /etc/nginx/ssl/private.key;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     client_max_body_size 100M;
#     access_log /var/log/nginx/nginx-proxy-access-ssl.log;
#     error_log  /var/log/nginx/nginx-proxy-error-ssl.log;
#
#     location /api/ { ... }  # 위와 동일한 proxy_set_header (클라이언트 IP 필수)
#     location /share/ { ... }
#     location /health { ... }
#     location / { ... }
# }
# HTTP → HTTPS 리다이렉트 (SSL 적용 시)
# server { listen 80; server_name your-domain.com; return 301 https://$server_name$request_uri; }
