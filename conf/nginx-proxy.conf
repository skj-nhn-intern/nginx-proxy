# Nginx Proxy — 프론트 정적 서빙 + 백엔드 API 리버스 프록시
# - / → 프론트엔드 정적(SPA, /opt/nginx-proxy/static)
# - /api/* → 백엔드 API, /share/* → 공유 링크(photo-api), /health → 헬스
# - 클라이언트 IP 무조건 추적 (X-Forwarded-For, X-Real-IP)
# - SSL은 추후 추가 예정 (아래 HTTPS 블록 참고)

# 업스트림: conf.d/backend.upstream.conf 에서 정의 (NHN Deploy 시 BACKEND_UPSTREAM으로 생성)
include /opt/nginx-proxy/conf.d/backend.upstream.conf;

# ========== 메트릭/추적용 로그 (Loki 본문 최적화) ==========
# 로그 본문(Line)에 포함: request_id, client_id, remote_addr, upstream_response_time,
#   request_uri, uri, status, method, bytes_sent, time, service, request_time
# → Promtail 레이블은 app, instance, log_type 만 사용 (카디널리티 최소화)
# client_id: 클라이언트가 X-Client-ID 헤더로 보내면 로그/백엔드에 전달
# x_forwarded_for_raw: LB가 보낸 원본 헤더 (real_ip 적용 전 확인용, 문제 해결 후 제거 가능)
log_format metrics_json escape=json '{'
  '"request_id":"$request_id",'
  '"client_id":"$http_x_client_id",'
  '"time":"$time_iso8601",'
  '"service":"nginx",'
  '"method":"$request_method",'
  '"uri":"$uri",'
  '"request_uri":"$request_uri",'
  '"status":$status,'
  '"request_time":$request_time,'
  '"upstream_response_time":"$upstream_response_time",'
  '"remote_addr":"$remote_addr",'
  '"x_forwarded_for_raw":"$http_x_forwarded_for",'
  '"x_real_ip_raw":"$http_x_real_ip",'
  '"bytes_sent":$bytes_sent'
'}';

# ========== 트래픽 효율 (http 컨텍스트) ==========
proxy_buffer_size 128k;
proxy_buffers 4 256k;
proxy_busy_buffers_size 256k;
proxy_max_temp_file_size 0;
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;

server {
    listen 80 default_server;
    server_name _;
    # client_max_body_size: 사진 업로드 등 대용량 요청
    client_max_body_size 100M;

    access_log /var/log/nginx/nginx-proxy-access.log metrics_json;
    error_log  /var/log/nginx/nginx-proxy-error.log;

    # ========== 클라이언트 IP 추적 (LB 뒤에서 실제 클라이언트 IP 사용) ==========
    # set_real_ip_from: 신뢰하는 프록시(LB) IP. LB IP는 보안상 .env의 REAL_IP_FROM으로만 주입 (conf.d/real_ip_from.conf)
    include /opt/nginx-proxy/conf.d/real_ip_from.conf;
    set_real_ip_from 10.0.0.0/8;
    set_real_ip_from 172.16.0.0/12;
    set_real_ip_from 192.168.0.0/16;
    set_real_ip_from 127.0.0.0/8;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    # API: /api/* → 백엔드 / (prefix 제거)
    location /api/ {
        rewrite ^/api/(.*) /$1 break;
        proxy_pass http://photo_api_backend;

        proxy_set_header X-Request-ID $request_id;
        proxy_set_header X-Client-ID $http_x_client_id;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Host $host;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # 공유 링크 페이지: /share/{token} — SPA 라우트 (index.html 서빙, API는 /api/share/* 로 호출)
    location /share/ {
        try_files $uri $uri/ /index.html;
    }

    # nginx 자체 검증용 (백엔드 무관, CI/로드밸런서용)
    location = /_nginx_health {
        access_log off;
        default_type text/plain;
        return 200 'ok\n';
    }

    # 헬스체크 (백엔드 /health 프록시, 로드밸런서/배포 검증용)
    location /health {
        proxy_pass http://photo_api_backend/health;
        proxy_set_header X-Request-ID $request_id;
        proxy_set_header X-Client-ID $http_x_client_id;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        access_log off;
    }

    # nginx 메트릭 (Prometheus nginx-exporter용, localhost만 허용)
    location /stub_status {
        stub_status on;
        allow 127.0.0.1;
        deny all;
        access_log off;
    }

    # 프론트엔드 정적(SPA): /opt/nginx-proxy/static (이미지 빌드 시 frontend/dist 반영)
    root /opt/nginx-proxy/static;

    # JS/CSS 등 모듈 스크립트는 실제 파일만 서빙. 없으면 404 (index.html 반환 시 MIME type 오류 방지)
    location ~* \.(js|mjs|css|ico|svg|woff2?)$ {
        try_files $uri =404;
        add_header Cache-Control "public, max-age=31536000";
    }
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# ========== SSL (추후 적용 시 주석 해제 및 인증서 경로 설정) ==========
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
#
#     ssl_certificate     /etc/nginx/ssl/certificate.crt;
#     ssl_certificate_key /etc/nginx/ssl/private.key;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     client_max_body_size 100M;
#     access_log /var/log/nginx/nginx-proxy-access-ssl.log;
#     error_log  /var/log/nginx/nginx-proxy-error-ssl.log;
#
#     location /api/ { ... }  # 위와 동일한 proxy_set_header (클라이언트 IP 필수)
#     location /share/ { ... }
#     location /health { ... }
#     location / { ... }
# }
# HTTP → HTTPS 리다이렉트 (SSL 적용 시)
# server { listen 80; server_name your-domain.com; return 301 https://$server_name$request_uri; }
